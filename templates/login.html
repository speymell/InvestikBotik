{% extends 'layout.html' %}

{% block content %}
<div class="row justify-content-center mt-5">
    <div class="col-md-6">
        <div class="card shadow-lg">
            <div class="card-body text-center p-5">
                <h2 class="mb-4">Вход в InvestBot</h2>
                <p class="text-muted mb-4">Ваш помощник в мире инвестиций</p>
                
                <div class="mt-4 mb-4">
                    <i class="fas fa-chart-line fa-4x text-primary mb-3"></i>
                </div>
                
                <!-- Проверяем, откуда пришел пользователь -->
                <div id="loginOptions" class="d-grid gap-3">
                    <a href="{{ url_for('demo_login') }}" class="btn btn-primary btn-lg">
                        <i class="fas fa-play-circle me-2"></i>
                        Демо-режим
                    </a>
                    <a href="{{ url_for('debug_telegram') }}" class="btn btn-secondary btn-sm">
                        <i class="fas fa-bug me-2"></i>
                        Отладка Telegram
                    </a>
                </div>
                
                    <p class="small text-muted" id="loginInfo">
                        В демо-режиме вы можете протестировать все функции приложения.
                    </p>
                </div>

    <script>
    // Проверяем, запущено ли приложение в Telegram Web App
    function checkTelegramWebApp() {
        console.log('Проверка Telegram Web App...');
        
        // Сначала проверяем URL параметры (если пришли из Telegram)
        const urlParams = new URLSearchParams(window.location.search);
        const telegramId = urlParams.get('telegram_id');
        const username = urlParams.get('username');
        
        if (telegramId && username) {
            // Если есть параметры Telegram - автоматически входим
            console.log('Найдены параметры Telegram, автоматический вход...');
            return; // Позволяем серверу обработать автоматический вход
        }
        
        // Проверяем наличие Telegram Web App API
        if (window.Telegram && window.Telegram.WebApp) {
            const tg = window.Telegram.WebApp;
            
            // Важно! Сообщаем Telegram что приложение готово
            tg.ready();
            tg.expand();
            
            console.log('Telegram Web App доступен:', tg);
            console.log('Platform:', tg.platform);
            console.log('initData:', tg.initData);
            console.log('initDataUnsafe:', tg.initDataUnsafe);
            
            // Пробуем разные способы получения данных пользователя
            let user = null;
            
            // Способ 1: через initDataUnsafe
            if (tg.initDataUnsafe && tg.initDataUnsafe.user) {
                user = tg.initDataUnsafe.user;
                console.log('Пользователь найден через initDataUnsafe:', user);
            }
            
            // Способ 2: парсим initData вручную
            if (!user && tg.initData) {
                try {
                    const initData = new URLSearchParams(tg.initData);
                    const userParam = initData.get('user');
                    if (userParam) {
                        user = JSON.parse(decodeURIComponent(userParam));
                        console.log('Пользователь найден через initData:', user);
                    }
                } catch (e) {
                    console.log('Ошибка парсинга initData:', e);
                }
            }
            
            if (user && user.id) {
                console.log('Найден Telegram Web App пользователь:', user);
                // Автоматически перенаправляем с данными Telegram
                const params = new URLSearchParams({
                    telegram_id: user.id,
                    username: user.username || user.first_name || `User${user.id}`
                });
                
                window.location.href = `/login?${params.toString()}`;
                return;
            }
            
            // Показываем кнопку для входа через Telegram с улучшенной логикой
            const loginOptions = document.getElementById('loginOptions');
            const telegramBtn = document.createElement('button');
            telegramBtn.className = 'btn btn-info btn-lg mb-2';
            telegramBtn.innerHTML = '<i class="fab fa-telegram-plane me-2"></i>Войти через Telegram';
            telegramBtn.onclick = function() {
                console.log('Нажата кнопка входа через Telegram');
                
                // Пытаемся получить данные пользователя всеми способами
                let user = null;
                
                if (tg.initDataUnsafe?.user) {
                    user = tg.initDataUnsafe.user;
                } else if (tg.initData) {
                    try {
                        const initData = new URLSearchParams(tg.initData);
                        const userParam = initData.get('user');
                        if (userParam) {
                            user = JSON.parse(decodeURIComponent(userParam));
                        }
                    } catch (e) {
                        console.log('Ошибка парсинга:', e);
                    }
                }
                
                if (user && user.id) {
                    const params = new URLSearchParams({
                        telegram_id: user.id,
                        username: user.username || user.first_name || `User${user.id}`
                    });
                    window.location.href = `/login?${params.toString()}`;
                } else {
                    // Показываем подробную информацию об ошибке
                    console.log('Отладочная информация:');
                    console.log('tg.initData:', tg.initData);
                    console.log('tg.initDataUnsafe:', tg.initDataUnsafe);
                    
                    alert(`Не удалось получить данные пользователя Telegram.\n\nОтладочная информация:\ninitData: ${tg.initData ? 'есть' : 'нет'}\ninitDataUnsafe: ${tg.initDataUnsafe ? 'есть' : 'нет'}\n\nПопробуйте перезапустить приложение через бота.`);
                }
            };
            
            loginOptions.insertBefore(telegramBtn, loginOptions.firstChild);
            
            // Обновляем информационное сообщение
            const loginInfo = document.getElementById('loginInfo');
            loginInfo.innerHTML = 'Приложение запущено в Telegram. Нажмите кнопку выше для входа или используйте демо-режим.';
        } else {
            console.log('Telegram Web App API недоступен');
            // Показываем сообщение о том, что лучше открыть в Telegram
            const loginInfo = document.getElementById('loginInfo');
            loginInfo.innerHTML = 'Для полного функционала откройте приложение через Telegram бота. Сейчас доступен только демо-режим.';
        }
    }

    // Запускаем проверку при загрузке страницы
    document.addEventListener('DOMContentLoaded', checkTelegramWebApp);
    </script>
            </div>
        </div>
    </div>
</div>

<style>
.divider {
    display: flex;
    align-items: center;
    text-align: center;
}

.divider::before,
.divider::after {
    content: '';
    flex: 1;
    border-bottom: 1px solid #dee2e6;
}

.divider span {
    padding: 0 10px;
}
</style>
{% endblock %}
