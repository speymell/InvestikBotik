{% extends 'layout.html' %}

{% block content %}
<div class="row">
    <div class="col-md-6 d-flex align-items-center gap-2 flex-wrap">
        <h2 class="mb-0">Инвестиции</h2>
        <!-- Фильтр Акции/Облигации -->
        <div class="btn-group instrument-toggle" role="group" aria-label="Тип инструмента">
            <a href="{{ url_for('stocks', type='share', search=search, sort=sort) }}" class="btn btn-outline-primary {% if ins_type == 'share' %}active{% endif %}">
                <i class="fas fa-chart-line me-1"></i>Акции
            </a>
            <a href="{{ url_for('stocks', type='bond', search=search, sort=sort) }}" class="btn btn-outline-primary {% if ins_type == 'bond' %}active{% endif %}">
                <i class="fas fa-file-contract me-1"></i>Облигации
            </a>
        </div>
    </div>
    <div class="col-md-6 d-flex justify-content-md-end align-items-center gap-2 mt-3 mt-md-0 flex-wrap">
        <!-- Переключатель рынков (Фондовый/Crypto) -->
        <div class="market-switcher">
            <button class="market-btn active" id="stocksBtn" onclick="switchMarket('stocks')">
                <i class="fas fa-building-columns me-2"></i>Фондовый
            </button>
            <button class="market-btn" id="cryptoBtn" onclick="switchMarket('crypto')">
                <i class="fas fa-rocket me-2"></i>Crypto
            </button>
        </div>
        
        <!-- Сортировка: поле + направление -->
        <div class="d-flex align-items-center sort-controls">
            <label class="me-2 text-muted d-none d-sm-inline">Сортировка:</label>
            <select class="form-select form-select-sm" id="sortFieldSelect">
                <option value="price">Цена</option>
                <option value="change">Изм. %</option>
                <option value="turnover">Оборот</option>
                <option value="volume">Объём</option>
                <option value="name">Название</option>
                <option value="ticker">Тикер</option>
                <option value="sector">Сектор</option>
            </select>
            <button class="btn btn-outline-secondary btn-sm ms-2" id="sortDirBtn" type="button" onclick="toggleSortDir()" title="Переключить направление">
                <i class="fas" id="sortDirIcon"></i>
            </button>
        </div>
        <a href="{{ url_for('alerts_page') }}" class="btn btn-outline-secondary btn-sm" title="Перейти к напоминаниям">
            <i class="fas fa-bell me-1"></i> Алерты
        </a>
    </div>
</div>

<!-- Секция Акций -->
<div id="stocksSection">
    <div class="row mt-3">
        <div class="col-md-6">
            <form method="GET" class="d-flex">
                <input type="hidden" name="type" value="{{ ins_type }}">
                <input type="hidden" name="sort" value="{{ sort }}">
                <input class="form-control me-2" type="search" name="search" placeholder="Поиск по тикеру или названию" value="{{ search }}">
                <button class="btn btn-outline-success" type="submit">Поиск</button>
            </form>
        </div>
    </div>

    {% if top_by_turnover %}
    <div class="col-md-12 mt-4">
        <div class="card turnover-section">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h6 class="mb-0">Топ по обороту (сегодня)</h6>
                <div class="d-flex align-items-center gap-2">
                    <small class="text-muted d-none d-sm-inline">MOEX marketdata</small>
                    <div class="turnover-nav">
                        <button class="btn btn-sm btn-outline-secondary" type="button" onclick="scrollTurnover(-1);"><i class="fas fa-chevron-left"></i></button>
                        <button class="btn btn-sm btn-outline-secondary" type="button" onclick="scrollTurnover(1);"><i class="fas fa-chevron-right"></i></button>
                    </div>
                </div>
            </div>
            <div class="card-body-list py-2">
                <div class="turnover-track" id="turnoverTrack">
                    {% for s in top_by_turnover %}
                    <a class="turnover-item" href="{{ url_for('stock_detail', ticker=s.ticker) }}" title="{{ s.name }}">
                        <div class="ti-head">
                            <img src="{{ s.logo_url }}" alt="{{ s.ticker }}" class="ti-logo">
                            <div class="ti-ticker">{{ s.ticker }}</div>
                        </div>
                        <div class="ti-price">{{ "%.2f"|format(s.price or 0) }} ₽</div>
                        <div class="ti-turnover">{{ "{:,.0f}".format(s.turnover or 0) }} ₽</div>
                    </a>
                    {% endfor %}
                </div>
            </div>
        </div>
    </div>
    {% endif %}

    <div class="col-md-12 mt-4">
        <div class="card">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h5 class="mb-0">Список {% if ins_type == 'bond' %}облигаций{% else %}акций{% endif %}</h5>
                <button class="btn btn-sm btn-outline-success" onclick="updateAllPrices();" id="manualUpdateBtn">
                    <i class="fas fa-sync-alt me-1"></i>Обновить цены
                </button>
            </div>
            <div class="card-body">
                <!-- Десктоп версия -->
                <div class="table-responsive d-none d-md-block">
                    <table class="table table-hover align-middle">
                        <thead>
                            <tr>
                                <th>Акция</th>
                                <th style="width: 180px;">Сектор</th>
                                <th style="width: 140px;" class="text-end">Цена</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for stock in stocks.items %}
                            <tr data-ticker="{{ stock.ticker }}" data-stock-id="{{ stock.id }}" style="cursor: pointer;">
                                <td onclick="window.location.href='{{ url_for('stock_detail', ticker=stock.ticker) }}';">
                                    <div class="d-flex align-items-center gap-2">
                                        <img src="{{ stock.logo_url or ('https://ui-avatars.com/api/?name=' ~ stock.ticker ~ '&background=007bff&color=fff&size=32') }}" 
                                             alt="{{ stock.ticker }}" class="stock-logo" style="margin-right: .5rem;">
                                        <div class="me-2">
                                            <strong>{{ stock.ticker }}</strong><br>
                                            <small class="text-muted">{{ stock.name[:30] }}{% if stock.name|length > 30 %}...{% endif %}</small>
                                        </div>
                                        {% if session.get('user_id') %}
                                        <button class="btn btn-outline-warning icon-btn watch-toggle" type="button" data-stock-id="{{ stock.id }}" title="Избранное">
                                            <i class="far fa-star"></i>
                                        </button>
                                        {% endif %}
                                    </div>
                                </td>
                                <td>
                                    {% if stock.sector %}
                                        <span class="badge bg-primary">{{ stock.sector }}</span>
                                    {% else %}
                                        <span class="badge bg-secondary">Прочие</span>
                                    {% endif %}
                                </td>
                                <td class="text-end">
                                    <div class="d-flex justify-content-end align-items-center gap-2">
                                        {% if stock.price > 0 %}
                                            <strong class="stock-price">{{ "%.2f"|format(stock.price) }} ₽</strong>
                                        {% else %}
                                            <span class="text-muted">Н/Д</span>
                                        {% endif %}
                                        {% if session.get('user_id') %}
                                        <button class="btn btn-outline-secondary icon-btn alert-create" type="button" data-stock-id="{{ stock.id }}" data-ticker="{{ stock.ticker }}" data-current-price="{{ stock.price }}" title="Создать оповещение">
                                            <i class="fas fa-bell"></i>
                                        </button>
                                        {% endif %}
                                    </div>
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
                
                <!-- Мобильная версия -->
                <div class="d-block d-md-none">
                    {% for stock in stocks.items %}
                    <div class="stock-mobile-item" data-ticker="{{ stock.ticker }}" data-stock-id="{{ stock.id }}">
                        <div class="d-flex align-items-center stock_card">
                            <div class="stock-mobile-logo">
                                <img src="{{ stock.logo_url or ('https://ui-avatars.com/api/?name=' ~ stock.ticker ~ '&background=007bff&color=fff&size=40') }}" 
                                     alt="{{ stock.ticker }}" class="stock-logo-mobile">
                            </div>
                            <div class="stock-mobile-info flex-grow-1">
                                <div class="d-flex justify-content-between align-items-start">
                                    <div onclick="window.location.href='{{ url_for('stock_detail', ticker=stock.ticker) }}';">
                                        <div class="stock-mobile-ticker">{{ stock.ticker }}</div>
                                        <div class="stock-mobile-name">{{ stock.name[:25] }}{% if stock.name|length > 25 %}...{% endif %}</div>
                                        {% if stock.sector %}
                                            <span class="badge bg-primary mobile-badge">{{ stock.sector }}</span>
                                        {% else %}
                                            <span class="badge bg-secondary mobile-badge">Прочие</span>
                                        {% endif %}
                                    </div>
                                    <div class="text-end">
                                        <div class="stock-mobile-price stock-price">
                                            {% if stock.price > 0 %}
                                                {{ "%.2f"|format(stock.price) }} ₽
                                            {% else %}
                                                <span class="text-muted">Н/Д</span>
                                            {% endif %}
                                        </div>
                                        {% if session.get('user_id') %}
                                        <div class="stock-mobile-actions">
                                            <button class="btn btn-outline-warning icon-btn watch-toggle" type="button" data-stock-id="{{ stock.id }}" title="Избранное">
                                                <i class="far fa-star"></i>
                                            </button>
                                            <button class="btn btn-outline-secondary icon-btn alert-create" type="button" data-stock-id="{{ stock.id }}" data-ticker="{{ stock.ticker }}" data-current-price="{{ stock.price }}" title="Создать оповещение">
                                                <i class="fas fa-bell"></i>
                                            </button>
                                        </div>
                                        {% endif %}
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    {% endfor %}
                </div>
                
                {% if not stocks.items %}
                <div class="text-center py-4">
                    {% if ins_type == 'bond' %}
                        <p class="text-muted">Облигации не загружены.</p>
                        {% if session.get('user_id') %}
                        <button class="btn btn-outline-primary" onclick="syncBonds(event)">
                            <i class="fas fa-arrow-rotate-right me-1"></i>Загрузить облигации
                        </button>
                        {% endif %}
                    {% else %}
                        <p class="text-muted">Акции не найдены</p>
                    {% endif %}
                </div>
                {% endif %}
            </div>
        </div>
    </div>
</div>

    <!-- Пагинация -->
    {% if stocks.pages > 1 %}
    <div class="row mt-3" id="stocksPagination">
        <div class="col-md-12">
            <nav>
                <ul class="pagination justify-content-center">
                    {% if stocks.has_prev %}
                    <li class="page-item">
                        <a class="page-link" href="{{ url_for('stocks', page=stocks.prev_num, search=search, type=ins_type, sort=sort) }}">Предыдущая</a>
                    </li>
                    {% endif %}
                    
                    {% for page_num in stocks.iter_pages() %}
                        {% if page_num %}
                            {% if page_num != stocks.page %}
                            <li class="page-item">
                                <a class="page-link" href="{{ url_for('stocks', page=page_num, search=search, type=ins_type, sort=sort) }}">{{ page_num }}</a>
                            </li>
                            {% else %}
                            <li class="page-item active">
                                <span class="page-link">{{ page_num }}</span>
                            </li>
                            {% endif %}
                        {% else %}
                        <li class="page-item disabled">
                            <span class="page-link">…</span>
                        </li>
                        {% endif %}
                    {% endfor %}
                    
                    {% if stocks.has_next %}
                    <li class="page-item">
                        <a class="page-link" href="{{ url_for('stocks', page=stocks.next_num, search=search, type=ins_type, sort=sort) }}">Следующая</a>
                    </li>
                    {% endif %}
                </ul>
            </nav>
        </div>
    </div>
    {% endif %}
</div>
<!-- Конец секции акций -->

<!-- Секция Crypto -->
<div id="cryptoSection" style="display: none;">
    <div class="row mt-4">
        <div class="col-md-12">
            <div class="crypto-coming-soon">
                <div class="space-background">
                    <div class="stars"></div>
                    <div class="stars2"></div>
                    <div class="stars3"></div>
                </div>
                
                <div class="crypto-content">
                    <div class="rocket-icon">
                        <i class="fas fa-rocket"></i>
                    </div>
                    <h1 class="crypto-title">Crypto Trading</h1>
                    <h3 class="crypto-subtitle">Soon...</h3>
                    <p class="crypto-description">
                        Новая функция в разработке!
                    </p>
                    <div class="crypto-features">
                        <div class="crypto-feature">
                            <i class="fab fa-bitcoin"></i>
                            <span>Bitcoin</span>
                        </div>
                        <div class="crypto-feature">
                            <i class="fab fa-ethereum"></i>
                            <span>Ethereum</span>
                        </div>
                        <div class="crypto-feature">
                            <i class="fas fa-coins"></i>
                            <span>Altcoins</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
<!-- Конец секции Crypto -->

<!-- Модальное окно для создания оповещения -->
<div class="modal fade" id="alertModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Создать оповещение</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="mb-3">
                    <label class="form-label">Акция</label>
                    <div class="d-flex align-items-center">
                        <strong id="alertStockTicker"></strong>
                        <span class="text-muted ms-2" id="alertStockName"></span>
                    </div>
                    <small class="text-muted">Текущая цена: <span id="alertCurrentPrice"></span> ₽</small>
                </div>
                
                <div class="mb-3">
                    <label class="form-label">Направление</label>
                    <div class="btn-group w-100" role="group">
                        <input type="radio" class="btn-check" name="alertDirection" id="alertAbove" value="above" checked>
                        <label class="btn btn-outline-success" for="alertAbove">
                            <i class="fas fa-arrow-up me-1"></i>Выше цены
                        </label>
                        
                        <input type="radio" class="btn-check" name="alertDirection" id="alertBelow" value="below">
                        <label class="btn btn-outline-danger" for="alertBelow">
                            <i class="fas fa-arrow-down me-1"></i>Ниже цены
                        </label>
                    </div>
                </div>
                
                <div class="mb-3">
                    <label for="alertPrice" class="form-label">Цена для оповещения</label>
                    <input type="number" class="form-control" id="alertPrice" step="0.01" min="0.01" required>
                    <div class="form-text text-muted">Введите цену, при достижении которой хотите получить уведомление</div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Отмена</button>
                <button type="button" class="btn btn-primary" onclick="submitAlert()">Создать оповещение</button>
            </div>
        </div>
    </div>
</div>

<script>
function scrollTurnover(dir) {
    const track = document.getElementById('turnoverTrack');
    if (!track) return;
    const card = track.querySelector('.turnover-item');
    const step = card ? (card.getBoundingClientRect().width + 12) * 3 : 300;
    track.scrollBy({ left: dir * step, behavior: 'smooth' });
}

// Новая сортировка: поле + направление
const initialSort = {{ sort|tojson }};
function parseSort(s) {
    const m = (s || '').match(/^(price|name|ticker|sector|turnover|volume|change)_(asc|desc)$/);
    return m ? {field: m[1], dir: m[2]} : {field: 'price', dir: 'desc'};
}
function sortKey(field, dir) { return `${field}_${dir}`; }
function applySort(field, dir) {
    const params = new URLSearchParams(window.location.search);
    params.set('sort', sortKey(field, dir));
    params.set('type', {{ ins_type|tojson }});
    const searchInput = document.querySelector('input[name="search"]');
    const searchVal = (searchInput && searchInput.value) ? searchInput.value : {{ search|tojson }};
    if (searchVal) params.set('search', searchVal);
    window.location.href = `{{ url_for('stocks') }}?` + params.toString();
}
function toggleSortDir() {
    const fieldSel = document.getElementById('sortFieldSelect');
    const icon = document.getElementById('sortDirIcon');
    let dir = icon.dataset.dir === 'asc' ? 'desc' : 'asc';
    applySort(fieldSel.value, dir);
}

async function syncBonds(ev) {
    const btn = ev.target.closest('button');
    const original = btn.innerHTML;
    btn.disabled = true; btn.innerHTML = '<i class="fas fa-spinner fa-spin me-1"></i>Загружаем...';
    try {
        const resp = await fetch('/admin/sync-bonds');
        const data = await resp.json();
        if (data.status === 'success') {
            location.reload();
        } else {
            alert('Ошибка: ' + (data.message || 'неизвестно'));
            btn.disabled = false; btn.innerHTML = original;
        }
    } catch (e) {
        alert('Ошибка сети');
        btn.disabled = false; btn.innerHTML = original;
    }
}

function switchMarket(market) {
    const stocksSection = document.getElementById('stocksSection');
    const cryptoSection = document.getElementById('cryptoSection');
    const stocksBtn = document.getElementById('stocksBtn');
    const cryptoBtn = document.getElementById('cryptoBtn');
    const pagination = document.getElementById('stocksPagination');
    
    if (market === 'stocks') {
        stocksSection.style.display = 'block';
        cryptoSection.style.display = 'none';
        stocksBtn.classList.add('active');
        cryptoBtn.classList.remove('active');
        if (pagination) pagination.style.display = '';
        localStorage.setItem('selectedMarket', 'stocks');
    } else {
        stocksSection.style.display = 'none';
        cryptoSection.style.display = 'block';
        stocksBtn.classList.remove('active');
        cryptoBtn.classList.add('active');
        if (pagination) pagination.style.display = 'none';
        localStorage.setItem('selectedMarket', 'crypto');
    }
}

// Восстановление выбора при загрузке страницы
document.addEventListener('DOMContentLoaded', function() {
    const savedMarket = localStorage.getItem('selectedMarket') || 'stocks';
    if (savedMarket === 'crypto') {
        switchMarket('crypto');
    }
    // Принудительно скрываем пагинацию, если выбран crypto при загрузке
    if (savedMarket === 'crypto') {
        const pagination = document.getElementById('stocksPagination');
        if (pagination) pagination.style.display = 'none';
    }
    
    // Запускаем автоматическое обновление цен
    startPriceUpdates();

    // Инициализация сортировки UI
    const {field, dir} = parseSort(initialSort);
    const fieldSel = document.getElementById('sortFieldSelect');
    if (fieldSel) {
        fieldSel.value = field;
        fieldSel.addEventListener('change', function(){
            applySort(this.value, document.getElementById('sortDirIcon').dataset.dir || dir);
        });
    }
    const icon = document.getElementById('sortDirIcon');
    if (icon) {
        icon.className = 'fas ' + (dir === 'desc' ? 'fa-arrow-down-wide-short' : 'fa-arrow-up-short-wide');
        icon.dataset.dir = dir;
    }
});

// Автоматическое обновление цен
let priceUpdateInterval;

function startPriceUpdates() {
    // Обновляем цены сразу при загрузке
    updateAllPrices();
    
    // Затем обновляем каждые 2 минуты (120 секунд)
    priceUpdateInterval = setInterval(updateAllPrices, 120000);
}

async function updateAllPrices() {
    const manualBtn = document.getElementById('manualUpdateBtn');
    const originalText = manualBtn?.innerHTML;
    
    try {
        // Показываем индикацию загрузки
        if (manualBtn) {
            manualBtn.disabled = true;
            manualBtn.innerHTML = '<i class="fas fa-spinner fa-spin me-1"></i>Обновляем...';
        }
        
        console.log('Обновляем цены акций...');
        const response = await fetch('/api/update_all_prices');
        const data = await response.json();
        
        if (data.success) {
            console.log(`Обновлено ${data.updated_count} акций из ${data.total_count}`);
            
            // Обновляем отображение цен на странице
            data.results.forEach(result => {
                if (result.status === 'updated') {
                    updateStockPriceDisplay(result.ticker, result.new_price);
                }
            });
            
            // Показываем индикатор успешного обновления
            showUpdateIndicator('success', 'Цены обновлены');
            
            // Проверяем оповещения после обновления цен
            checkAlerts();
            
            // Обновляем кнопку
            if (manualBtn) {
                manualBtn.innerHTML = '<i class="fas fa-check me-1"></i>Обновлено!';
                setTimeout(() => {
                    manualBtn.innerHTML = originalText;
                    manualBtn.disabled = false;
                }, 2000);
            }
        } else {
            console.error('Ошибка обновления цен:', data.error);
            showUpdateIndicator('error', 'Ошибка обновления');
            
            // Восстанавливаем кнопку
            if (manualBtn) {
                manualBtn.innerHTML = originalText;
                manualBtn.disabled = false;
            }
        }
    } catch (error) {
        console.error('Ошибка при обновлении цен:', error);
        showUpdateIndicator('error', 'Ошибка соединения');
        
        // Восстанавливаем кнопку
        if (manualBtn) {
            manualBtn.innerHTML = originalText;
            manualBtn.disabled = false;
        }
    }
}

function updateStockPriceDisplay(ticker, newPrice) {
    // Обновляем цену в таблице акций
    const priceElements = document.querySelectorAll(`[data-ticker="${ticker}"] .stock-price`);
    priceElements.forEach(element => {
        const oldPrice = parseFloat(element.textContent.replace(/[^\d.,]/g, '').replace(',', '.'));
        element.textContent = `${newPrice.toFixed(2)} ₽`;
        
        // Добавляем анимацию изменения цены
        if (oldPrice !== newPrice) {
            element.classList.add('price-updated');
            setTimeout(() => element.classList.remove('price-updated'), 1000);
        }
    });
}

function showUpdateIndicator(type, message) {
    // Создаем или обновляем индикатор обновления
    let indicator = document.getElementById('priceUpdateIndicator');
    if (!indicator) {
        indicator = document.createElement('div');
        indicator.id = 'priceUpdateIndicator';
        indicator.className = 'price-update-indicator';
        document.body.appendChild(indicator);
    }
    
    indicator.className = `price-update-indicator ${type}`;
    indicator.innerHTML = `
        <i class="fas fa-${type === 'success' ? 'check' : 'exclamation-triangle'}"></i>
        ${message}
    `;
    
    // Показываем индикатор
    indicator.style.display = 'block';
    
    // Скрываем через 3 секунды
    setTimeout(() => {
        indicator.style.display = 'none';
    }, 3000);
}

// Останавливаем обновления при уходе со страницы
window.addEventListener('beforeunload', function() {
    if (priceUpdateInterval) {
        clearInterval(priceUpdateInterval);
    }
});
</script>
<script>
// Watchlist and Alerts (MVP)
document.addEventListener('DOMContentLoaded', async function() {
  try {
    const resp = await fetch('/api/watchlist');
    if (resp.ok) {
      const data = await resp.json();
      if (data && data.success && Array.isArray(data.stock_ids)) {
        document.querySelectorAll('.watch-toggle').forEach(btn => {
          const sid = Number(btn.dataset.stockId);
          if (data.stock_ids.includes(sid)) markWatch(btn, true);
        });
      }
    }
  } catch (e) {}

  document.body.addEventListener('click', async function(ev) {
    const wt = ev.target.closest('.watch-toggle');
    if (wt) {
      ev.preventDefault(); ev.stopPropagation();
      const sid = Number(wt.dataset.stockId);
      try {
        const r = await fetch('/api/watchlist/toggle', {method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({stock_id: sid})});
        const d = await r.json();
        if (d.success) markWatch(wt, d.action === 'added');
        else alert('Ошибка: ' + (d.error||'неизвестно'));
      } catch (e) { alert('Ошибка сети'); }
      return;
    }
    const ac = ev.target.closest('.alert-create');
    if (ac) {
      ev.preventDefault(); ev.stopPropagation();
      openAlertModal(ac);
      return;
    }
  }, {passive:false});
});

function markWatch(btn, added) {
  const i = btn.querySelector('i');
  if (!i) return;
  i.className = added ? 'fas fa-star' : 'far fa-star';
}

// Переменные для модального окна оповещений
let currentAlertStockId = null;

function openAlertModal(button) {
  const stockId = button.dataset.stockId;
  const ticker = button.dataset.ticker;
  const currentPrice = parseFloat(button.dataset.currentPrice);
  
  currentAlertStockId = stockId;
  
  // Заполняем данные в модальном окне
  document.getElementById('alertStockTicker').textContent = ticker;
  document.getElementById('alertCurrentPrice').textContent = currentPrice.toFixed(2);
  
  // Получаем название акции из DOM
  const stockRow = button.closest('[data-ticker]');
  const stockNameElement = stockRow ? stockRow.querySelector('small.text-muted') : null;
  const stockName = stockNameElement ? stockNameElement.textContent : '';
  document.getElementById('alertStockName').textContent = stockName;
  
  // Очищаем форму
  document.getElementById('alertPrice').value = '';
  document.getElementById('alertAbove').checked = true;
  
  // Показываем модальное окно
  const modal = new bootstrap.Modal(document.getElementById('alertModal'));
  modal.show();
}

async function submitAlert() {
  const stockId = currentAlertStockId;
  const direction = document.querySelector('input[name="alertDirection"]:checked').value;
  const price = parseFloat(document.getElementById('alertPrice').value);
  
  if (!price || price <= 0) {
    alert('Введите корректную цену');
    return;
  }
  
  try {
    const response = await fetch('/api/alerts/create', {
      method: 'POST',
      headers: {'Content-Type': 'application/json'},
      body: JSON.stringify({
        stock_id: stockId,
        direction: direction,
        price: price
      })
    });
    
    const data = await response.json();
    
    if (data.success) {
      alert('Оповещение создано успешно!');
      // Закрываем модальное окно
      const modal = bootstrap.Modal.getInstance(document.getElementById('alertModal'));
      modal.hide();
    } else {
      alert('Ошибка: ' + (data.error || 'неизвестно'));
    }
  } catch (error) {
    alert('Ошибка сети: ' + error.message);
  }
}

// Функция для проверки оповещений
async function checkAlerts() {
  try {
    const response = await fetch('/api/alerts/check', {
      method: 'POST',
      headers: {'Content-Type': 'application/json'}
    });
    
    const data = await response.json();
    
    if (data.success && data.triggered && data.triggered.length > 0) {
      // Показываем уведомления о сработавших оповещениях
      data.triggered.forEach(alert => {
        showAlertNotification(alert);
      });
    }
  } catch (error) {
    console.error('Ошибка при проверке оповещений:', error);
  }
}

// Функция для показа уведомления о сработавшем оповещении
function showAlertNotification(alertData) {
  const direction = alertData.direction === 'above' ? 'выше' : 'ниже';
  const directionIcon = alertData.direction === 'above' ? '↗️' : '↘️';
  
  // Создаем красивое уведомление
  const notification = document.createElement('div');
  notification.className = 'alert-notification';
  notification.innerHTML = `
    <div class="alert-notification-content">
      <div class="alert-notification-icon">
        <i class="fas fa-bell"></i>
      </div>
      <div class="alert-notification-text">
        <strong>${alertData.ticker}</strong> ${directionIcon}<br>
        <small>Цена ${direction} ${alertData.price} ₽</small><br>
        <small>Текущая: ${alertData.current_price ? alertData.current_price.toFixed(2) : alertData.price} ₽</small>
      </div>
      <button class="alert-notification-close" onclick="this.parentElement.parentElement.remove()">
        <i class="fas fa-times"></i>
      </button>
    </div>
  `;
  
  // Добавляем стили если их еще нет
  if (!document.getElementById('alertNotificationStyles')) {
    const styles = document.createElement('style');
    styles.id = 'alertNotificationStyles';
    styles.textContent = `
      .alert-notification {
        position: fixed;
        top: 20px;
        right: 20px;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        padding: 0;
        border-radius: 12px;
        box-shadow: 0 8px 32px rgba(0,0,0,0.3);
        z-index: 9999;
        animation: slideInRight 0.5s ease-out;
        margin-bottom: 10px;
        max-width: 300px;
      }
      .alert-notification-content {
        display: flex;
        align-items: center;
        padding: 15px;
      }
      .alert-notification-icon {
        font-size: 24px;
        margin-right: 12px;
        color: #ffd700;
      }
      .alert-notification-text {
        flex: 1;
        font-size: 14px;
      }
      .alert-notification-close {
        background: none;
        border: none;
        color: white;
        font-size: 16px;
        cursor: pointer;
        padding: 5px;
        margin-left: 10px;
        opacity: 0.7;
        transition: opacity 0.2s;
      }
      .alert-notification-close:hover {
        opacity: 1;
      }
      @keyframes slideInRight {
        from {
          transform: translateX(100%);
          opacity: 0;
        }
        to {
          transform: translateX(0);
          opacity: 1;
        }
      }
    `;
    document.head.appendChild(styles);
  }
  
  document.body.appendChild(notification);
  
  // Автоматически убираем уведомление через 10 секунд
  setTimeout(() => {
    if (notification.parentElement) {
      notification.remove();
    }
  }, 10000);
}
</script>
{% endblock %}
