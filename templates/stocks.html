{% extends 'layout.html' %}

{% block content %}
<div class="row">
    <div class="col-md-12">
        <div class="d-flex justify-content-between align-items-center flex-wrap gap-3">
            <h2 class="mb-0">Инвестиции</h2>
            
            <div class="d-flex align-items-center gap-2">
                <!-- Фильтр Акции/Облигации -->
                <div class="btn-group" role="group" aria-label="Тип инструмента">
                    <a href="{{ url_for('stocks', type='share', search=search) }}" class="btn btn-outline-primary {% if request.args.get('type', 'share') == 'share' %}active{% endif %}">Акции</a>
                    <a href="{{ url_for('stocks', type='bond', search=search) }}" class="btn btn-outline-primary {% if request.args.get('type') == 'bond' %}active{% endif %}">Облигации</a>
                </div>
                
                <!-- Переключатель Акции/Crypto -->
                <div class="market-switcher">
                    <button class="market-btn active" id="stocksBtn" onclick="switchMarket('stocks')">
                        <i class="fas fa-chart-line me-2"></i>Акции
                    </button>
                    <button class="market-btn" id="cryptoBtn" onclick="switchMarket('crypto')">
                        <i class="fas fa-rocket me-2"></i>Crypto
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Секция Акций -->
<div id="stocksSection">
    <div class="row mt-3">
        <div class="col-md-6">
            <form method="GET" class="d-flex">
                <input class="form-control me-2" type="search" name="search" placeholder="Поиск по тикеру или названию" value="{{ search }}">
                <button class="btn btn-outline-success" type="submit">Поиск</button>
            </form>
        </div>
    </div>

    <div class="col-md-12 mt-4">
        <div class="card">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h5 class="mb-0">Список акций</h5>
                <button class="btn btn-sm btn-outline-success" onclick="updateAllPrices()" id="manualUpdateBtn">
                    <i class="fas fa-sync-alt me-1"></i>Обновить цены
                </button>
            </div>
            <div class="card-body">
                <!-- Десктоп версия -->
                <div class="table-responsive d-none d-md-block">
                    <table class="table table-hover align-middle">
                        <thead>
                            <tr>
                                <th>Акция</th>
                                <th style="width: 180px;">Сектор</th>
                                <th style="width: 140px;" class="text-end">Цена</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for stock in stocks %}
                            <tr data-ticker="{{ stock.ticker }}" onclick="window.location.href='{{ url_for('stock_detail', ticker=stock.ticker) }}'" style="cursor: pointer;">
                                <td>
                                    <div class="d-flex align-items-center gap-2">
                                        <img src="{{ stock.logo_url or ('https://ui-avatars.com/api/?name=' ~ stock.ticker ~ '&background=007bff&color=fff&size=32') }}" 
                                             alt="{{ stock.ticker }}" class="stock-logo" style="margin-right: .5rem;">
                                        <div>
                                            <strong>{{ stock.ticker }}</strong><br>
                                            <small class="text-muted">{{ stock.name[:30] }}{% if stock.name|length > 30 %}...{% endif %}</small>
                                        </div>
                                    </div>
                                </td>
                                <td>
                                    {% if stock.sector %}
                                        <span class="badge bg-primary">{{ stock.sector }}</span>
                                    {% else %}
                                        <span class="badge bg-secondary">Прочие</span>
                                    {% endif %}
                                </td>
                                <td class="text-end">
                                    {% if stock.price > 0 %}
                                        <strong class="stock-price">{{ "%.2f"|format(stock.price) }} ₽</strong>
                                    {% else %}
                                        <span class="text-muted">Н/Д</span>
                                    {% endif %}
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
                
                <!-- Мобильная версия -->
                <div class="d-block d-md-none">
                    {% for stock in stocks %}
                    <div class="stock-mobile-item" data-ticker="{{ stock.ticker }}" onclick="window.location.href='{{ url_for('stock_detail', ticker=stock.ticker) }}';">
                        <div class="d-flex align-items-center">
                            <div class="stock-mobile-logo">
                                <img src="{{ stock.logo_url or ('https://ui-avatars.com/api/?name=' ~ stock.ticker ~ '&background=007bff&color=fff&size=40') }}" 
                                     alt="{{ stock.ticker }}" class="stock-logo-mobile">
                            </div>
                            <div class="stock-mobile-info flex-grow-1">
                                <div class="d-flex justify-content-between align-items-start">
                                    <div>
                                        <div class="stock-mobile-ticker">{{ stock.ticker }}</div>
                                        <div class="stock-mobile-name">{{ stock.name[:25] }}{% if stock.name|length > 25 %}...{% endif %}</div>
                                        {% if stock.sector %}
                                            <span class="badge bg-primary mobile-badge">{{ stock.sector }}</span>
                                        {% else %}
                                            <span class="badge bg-secondary mobile-badge">Прочие</span>
                                        {% endif %}
                                    </div>
                                    <div class="text-end">
                                        <div class="stock-mobile-price stock-price">
                                            {% if stock.price > 0 %}
                                                {{ "%.2f"|format(stock.price) }} ₽
                                            {% else %}
                                                <span class="text-muted">Н/Д</span>
                                            {% endif %}
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    {% endfor %}
                </div>
                
                {% if not stocks.items %}
                <div class="text-center py-4">
                    <p class="text-muted">Акции не найдены</p>
                </div>
                {% endif %}
            </div>
        </div>
    </div>
</div>

    <!-- Пагинация -->
    {% if stocks.pages > 1 %}
    <div class="row mt-3" id="stocksPagination">
        <div class="col-md-12">
            <nav>
                <ul class="pagination justify-content-center">
                    {% if stocks.has_prev %}
                    <li class="page-item">
                        <a class="page-link" href="{{ url_for('stocks', page=stocks.prev_num, search=search) }}">Предыдущая</a>
                    </li>
                    {% endif %}
                    
                    {% for page_num in stocks.iter_pages() %}
                        {% if page_num %}
                            {% if page_num != stocks.page %}
                            <li class="page-item">
                                <a class="page-link" href="{{ url_for('stocks', page=page_num, search=search) }}">{{ page_num }}</a>
                            </li>
                            {% else %}
                            <li class="page-item active">
                                <span class="page-link">{{ page_num }}</span>
                            </li>
                            {% endif %}
                        {% else %}
                        <li class="page-item disabled">
                            <span class="page-link">…</span>
                        </li>
                        {% endif %}
                    {% endfor %}
                    
                    {% if stocks.has_next %}
                    <li class="page-item">
                        <a class="page-link" href="{{ url_for('stocks', page=stocks.next_num, search=search) }}">Следующая</a>
                    </li>
                    {% endif %}
                </ul>
            </nav>
        </div>
    </div>
    {% endif %}
</div>
<!-- Конец секции акций -->

<!-- Секция Crypto -->
<div id="cryptoSection" style="display: none;">
    <div class="row mt-4">
        <div class="col-md-12">
            <div class="crypto-coming-soon">
                <div class="space-background">
                    <div class="stars"></div>
                    <div class="stars2"></div>
                    <div class="stars3"></div>
                </div>
                
                <div class="crypto-content">
                    <div class="rocket-icon">
                        <i class="fas fa-rocket"></i>
                    </div>
                    <h1 class="crypto-title">Crypto Trading</h1>
                    <h3 class="crypto-subtitle">Soon...</h3>
                    <p class="crypto-description">
                        Новая функция в разработке!
                    </p>
                    <div class="crypto-features">
                        <div class="crypto-feature">
                            <i class="fab fa-bitcoin"></i>
                            <span>Bitcoin</span>
                        </div>
                        <div class="crypto-feature">
                            <i class="fab fa-ethereum"></i>
                            <span>Ethereum</span>
                        </div>
                        <div class="crypto-feature">
                            <i class="fas fa-coins"></i>
                            <span>Altcoins</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
<!-- Конец секции Crypto -->

<script>
function switchMarket(market) {
    const stocksSection = document.getElementById('stocksSection');
    const cryptoSection = document.getElementById('cryptoSection');
    const stocksBtn = document.getElementById('stocksBtn');
    const cryptoBtn = document.getElementById('cryptoBtn');
    const pagination = document.getElementById('stocksPagination');
    
    if (market === 'stocks') {
        stocksSection.style.display = 'block';
        cryptoSection.style.display = 'none';
        stocksBtn.classList.add('active');
        cryptoBtn.classList.remove('active');
        if (pagination) pagination.style.display = '';
        localStorage.setItem('selectedMarket', 'stocks');
    } else {
        stocksSection.style.display = 'none';
        cryptoSection.style.display = 'block';
        stocksBtn.classList.remove('active');
        cryptoBtn.classList.add('active');
        if (pagination) pagination.style.display = 'none';
        localStorage.setItem('selectedMarket', 'crypto');
    }
}

// Восстановление выбора при загрузке страницы
document.addEventListener('DOMContentLoaded', function() {
    const savedMarket = localStorage.getItem('selectedMarket') || 'stocks';
    if (savedMarket === 'crypto') {
        switchMarket('crypto');
    }
    // Принудительно скрываем пагинацию, если выбран crypto при загрузке
    if (savedMarket === 'crypto') {
        const pagination = document.getElementById('stocksPagination');
        if (pagination) pagination.style.display = 'none';
    }
    
    // Запускаем автоматическое обновление цен
    startPriceUpdates();
});

// Автоматическое обновление цен
let priceUpdateInterval;

function startPriceUpdates() {
    // Обновляем цены сразу при загрузке
    updateAllPrices();
    
    // Затем обновляем каждые 2 минуты (120 секунд)
    priceUpdateInterval = setInterval(updateAllPrices, 120000);
}

async function updateAllPrices() {
    const manualBtn = document.getElementById('manualUpdateBtn');
    const originalText = manualBtn?.innerHTML;
    
    try {
        // Показываем индикацию загрузки
        if (manualBtn) {
            manualBtn.disabled = true;
            manualBtn.innerHTML = '<i class="fas fa-spinner fa-spin me-1"></i>Обновляем...';
        }
        
        console.log('Обновляем цены акций...');
        const response = await fetch('/api/update_all_prices');
        const data = await response.json();
        
        if (data.success) {
            console.log(`Обновлено ${data.updated_count} акций из ${data.total_count}`);
            
            // Обновляем отображение цен на странице
            data.results.forEach(result => {
                if (result.status === 'updated') {
                    updateStockPriceDisplay(result.ticker, result.new_price);
                }
            });
            
            // Показываем индикатор успешного обновления
            showUpdateIndicator('success', 'Цены обновлены');
            
            // Обновляем кнопку
            if (manualBtn) {
                manualBtn.innerHTML = '<i class="fas fa-check me-1"></i>Обновлено!';
                setTimeout(() => {
                    manualBtn.innerHTML = originalText;
                    manualBtn.disabled = false;
                }, 2000);
            }
        } else {
            console.error('Ошибка обновления цен:', data.error);
            showUpdateIndicator('error', 'Ошибка обновления');
            
            // Восстанавливаем кнопку
            if (manualBtn) {
                manualBtn.innerHTML = originalText;
                manualBtn.disabled = false;
            }
        }
    } catch (error) {
        console.error('Ошибка при обновлении цен:', error);
        showUpdateIndicator('error', 'Ошибка соединения');
        
        // Восстанавливаем кнопку
        if (manualBtn) {
            manualBtn.innerHTML = originalText;
            manualBtn.disabled = false;
        }
    }
}

function updateStockPriceDisplay(ticker, newPrice) {
    // Обновляем цену в таблице акций
    const priceElements = document.querySelectorAll(`[data-ticker="${ticker}"] .stock-price`);
    priceElements.forEach(element => {
        const oldPrice = parseFloat(element.textContent.replace(/[^\d.,]/g, '').replace(',', '.'));
        element.textContent = `${newPrice.toFixed(2)} ₽`;
        
        // Добавляем анимацию изменения цены
        if (oldPrice !== newPrice) {
            element.classList.add('price-updated');
            setTimeout(() => element.classList.remove('price-updated'), 1000);
        }
    });
}

function showUpdateIndicator(type, message) {
    // Создаем или обновляем индикатор обновления
    let indicator = document.getElementById('priceUpdateIndicator');
    if (!indicator) {
        indicator = document.createElement('div');
        indicator.id = 'priceUpdateIndicator';
        indicator.className = 'price-update-indicator';
        document.body.appendChild(indicator);
    }
    
    indicator.className = `price-update-indicator ${type}`;
    indicator.innerHTML = `
        <i class="fas fa-${type === 'success' ? 'check' : 'exclamation-triangle'}"></i>
        ${message}
    `;
    
    // Показываем индикатор
    indicator.style.display = 'block';
    
    // Скрываем через 3 секунды
    setTimeout(() => {
        indicator.style.display = 'none';
    }, 3000);
}

// Останавливаем обновления при уходе со страницы
window.addEventListener('beforeunload', function() {
    if (priceUpdateInterval) {
        clearInterval(priceUpdateInterval);
    }
});
</script>
{% endblock %}
