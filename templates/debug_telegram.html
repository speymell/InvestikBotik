<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–û—Ç–ª–∞–¥–∫–∞ Telegram Web App</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 20px;
            background-color: #f5f5f5;
        }
        .debug-info {
            background: white;
            padding: 15px;
            margin: 10px 0;
            border-radius: 8px;
            border-left: 4px solid #007bff;
        }
        .error {
            border-left-color: #dc3545;
        }
        .success {
            border-left-color: #28a745;
        }
        pre {
            background: #f8f9fa;
            padding: 10px;
            border-radius: 4px;
            overflow-x: auto;
        }
        button {
            background: #007bff;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 4px;
            cursor: pointer;
            margin: 5px;
        }
        button:hover {
            background: #0056b3;
        }
    </style>
</head>
<body>
    <h1>üîç –û—Ç–ª–∞–¥–∫–∞ Telegram Web App</h1>
    
    <div class="debug-info">
        <h3>–ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ Telegram Web App:</h3>
        <div id="telegram-info"></div>
    </div>
    
    <div class="debug-info">
        <h3>–î–∞–Ω–Ω—ã–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è:</h3>
        <div id="user-info"></div>
    </div>
    
    <div class="debug-info">
        <h3>–î–µ–π—Å—Ç–≤–∏—è:</h3>
        <button onclick="tryLogin()">–ü–æ–ø—Ä–æ–±–æ–≤–∞—Ç—å –≤—Ö–æ–¥</button>
        <button onclick="refreshData()">–û–±–Ω–æ–≤–∏—Ç—å –¥–∞–Ω–Ω—ã–µ</button>
        <button onclick="goToDemo()">–î–µ–º–æ-—Ä–µ–∂–∏–º</button>
    </div>
    
    <div class="debug-info">
        <h3>–õ–æ–≥–∏:</h3>
        <div id="logs"></div>
    </div>

    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <script>
        let logs = [];
        
        function addLog(message, type = 'info') {
            const timestamp = new Date().toLocaleTimeString();
            logs.push(`[${timestamp}] ${message}`);
            updateLogsDisplay();
            console.log(message);
        }
        
        function updateLogsDisplay() {
            const logsDiv = document.getElementById('logs');
            logsDiv.innerHTML = '<pre>' + logs.slice(-10).join('\n') + '</pre>';
        }
        
        function displayTelegramInfo() {
            const infoDiv = document.getElementById('telegram-info');
            
            if (window.Telegram && window.Telegram.WebApp) {
                const tg = window.Telegram.WebApp;
                
                const info = {
                    '–í–µ—Ä—Å–∏—è': tg.version || '–Ω–µ–∏–∑–≤–µ—Å—Ç–Ω–æ',
                    '–ü–ª–∞—Ç—Ñ–æ—Ä–º–∞': tg.platform || '–Ω–µ–∏–∑–≤–µ—Å—Ç–Ω–æ',
                    '–¶–≤–µ—Ç–æ–≤–∞—è —Å—Ö–µ–º–∞': tg.colorScheme || '–Ω–µ–∏–∑–≤–µ—Å—Ç–Ω–æ',
                    '–†–∞–∑–≤–µ—Ä–Ω—É—Ç–æ': tg.isExpanded ? '–¥–∞' : '–Ω–µ—Ç',
                    '–í—ã—Å–æ—Ç–∞ –æ–∫–Ω–∞': tg.viewportHeight || '–Ω–µ–∏–∑–≤–µ—Å—Ç–Ω–æ',
                    '–°—Ç–∞–±–∏–ª—å–Ω–∞—è –≤—ã—Å–æ—Ç–∞': tg.viewportStableHeight || '–Ω–µ–∏–∑–≤–µ—Å—Ç–Ω–æ',
                    'initData –¥–æ—Å—Ç—É–ø–µ–Ω': tg.initData ? '–¥–∞' : '–Ω–µ—Ç',
                    'initDataUnsafe –¥–æ—Å—Ç—É–ø–µ–Ω': tg.initDataUnsafe ? '–¥–∞' : '–Ω–µ—Ç'
                };
                
                let html = '<table border="1" style="border-collapse: collapse; width: 100%;">';
                for (const [key, value] in Object.entries(info)) {
                    html += `<tr><td><strong>${key}</strong></td><td>${value}</td></tr>`;
                }
                html += '</table>';
                
                infoDiv.innerHTML = html;
                infoDiv.className = 'success';
                
                addLog('Telegram Web App API –¥–æ—Å—Ç—É–ø–µ–Ω');
                
                // –†–∞—Å—à–∏—Ä—è–µ–º –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ
                tg.expand();
                addLog('–ü—Ä–∏–ª–æ–∂–µ–Ω–∏–µ —Ä–∞–∑–≤–µ—Ä–Ω—É—Ç–æ');
                
            } else {
                infoDiv.innerHTML = '<p style="color: red;">‚ùå Telegram Web App API –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω</p>';
                infoDiv.className = 'error';
                addLog('Telegram Web App API –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω', 'error');
            }
        }
        
        function displayUserInfo() {
            const userDiv = document.getElementById('user-info');
            
            if (window.Telegram && window.Telegram.WebApp) {
                const tg = window.Telegram.WebApp;
                let user = null;
                let method = '';
                
                // –ü—Ä–æ–±—É–µ–º —Ä–∞–∑–Ω—ã–µ —Å–ø–æ—Å–æ–±—ã –ø–æ–ª—É—á–µ–Ω–∏—è –¥–∞–Ω–Ω—ã—Ö
                if (tg.initDataUnsafe && tg.initDataUnsafe.user) {
                    user = tg.initDataUnsafe.user;
                    method = 'initDataUnsafe';
                    addLog('–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–∞–π–¥–µ–Ω —á–µ—Ä–µ–∑ initDataUnsafe');
                } else if (tg.initData) {
                    try {
                        const initData = new URLSearchParams(tg.initData);
                        const userParam = initData.get('user');
                        if (userParam) {
                            user = JSON.parse(decodeURIComponent(userParam));
                            method = 'initData parsing';
                            addLog('–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–∞–π–¥–µ–Ω —á–µ—Ä–µ–∑ –ø–∞—Ä—Å–∏–Ω–≥ initData');
                        }
                    } catch (e) {
                        addLog(`–û—à–∏–±–∫–∞ –ø–∞—Ä—Å–∏–Ω–≥–∞ initData: ${e.message}`, 'error');
                    }
                }
                
                if (user) {
                    const userInfo = {
                        'ID': user.id,
                        '–ò–º—è': user.first_name || '–Ω–µ —É–∫–∞–∑–∞–Ω–æ',
                        '–§–∞–º–∏–ª–∏—è': user.last_name || '–Ω–µ —É–∫–∞–∑–∞–Ω–æ',
                        'Username': user.username || '–Ω–µ —É–∫–∞–∑–∞–Ω–æ',
                        '–Ø–∑—ã–∫': user.language_code || '–Ω–µ —É–∫–∞–∑–∞–Ω–æ',
                        '–ü—Ä–µ–º–∏—É–º': user.is_premium ? '–¥–∞' : '–Ω–µ—Ç',
                        '–ú–µ—Ç–æ–¥ –ø–æ–ª—É—á–µ–Ω–∏—è': method
                    };
                    
                    let html = '<table border="1" style="border-collapse: collapse; width: 100%;">';
                    for (const [key, value] of Object.entries(userInfo)) {
                        html += `<tr><td><strong>${key}</strong></td><td>${value}</td></tr>`;
                    }
                    html += '</table>';
                    
                    userDiv.innerHTML = html;
                    userDiv.className = 'success';
                } else {
                    userDiv.innerHTML = '<p style="color: red;">‚ùå –î–∞–Ω–Ω—ã–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –Ω–µ –Ω–∞–π–¥–µ–Ω—ã</p>';
                    userDiv.className = 'error';
                    addLog('–î–∞–Ω–Ω—ã–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –Ω–µ –Ω–∞–π–¥–µ–Ω—ã', 'error');
                    
                    // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Å—ã—Ä—ã–µ –¥–∞–Ω–Ω—ã–µ –¥–ª—è –æ—Ç–ª–∞–¥–∫–∏
                    if (tg.initData) {
                        userDiv.innerHTML += `<p><strong>–°—ã—Ä—ã–µ initData:</strong></p><pre>${tg.initData}</pre>`;
                    }
                    if (tg.initDataUnsafe) {
                        userDiv.innerHTML += `<p><strong>initDataUnsafe:</strong></p><pre>${JSON.stringify(tg.initDataUnsafe, null, 2)}</pre>`;
                    }
                }
            }
        }
        
        function tryLogin() {
            addLog('–ü–æ–ø—ã—Ç–∫–∞ –≤—Ö–æ–¥–∞...');
            
            if (window.Telegram && window.Telegram.WebApp) {
                const tg = window.Telegram.WebApp;
                let user = null;
                
                if (tg.initDataUnsafe?.user) {
                    user = tg.initDataUnsafe.user;
                } else if (tg.initData) {
                    try {
                        const initData = new URLSearchParams(tg.initData);
                        const userParam = initData.get('user');
                        if (userParam) {
                            user = JSON.parse(decodeURIComponent(userParam));
                        }
                    } catch (e) {
                        addLog(`–û—à–∏–±–∫–∞: ${e.message}`, 'error');
                    }
                }
                
                if (user && user.id) {
                    const params = new URLSearchParams({
                        telegram_id: user.id,
                        username: user.username || user.first_name || `User${user.id}`
                    });
                    
                    const loginUrl = `/login?${params.toString()}`;
                    addLog(`–ü–µ—Ä–µ–Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –Ω–∞: ${loginUrl}`);
                    window.location.href = loginUrl;
                } else {
                    addLog('–ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–ª—É—á–∏—Ç—å –¥–∞–Ω–Ω—ã–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –¥–ª—è –≤—Ö–æ–¥–∞', 'error');
                }
            } else {
                addLog('Telegram Web App API –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω', 'error');
            }
        }
        
        function refreshData() {
            addLog('–û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö...');
            displayTelegramInfo();
            displayUserInfo();
        }
        
        function goToDemo() {
            addLog('–ü–µ—Ä–µ—Ö–æ–¥ –≤ –¥–µ–º–æ-—Ä–µ–∂–∏–º...');
            window.location.href = '/demo_login';
        }
        
        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
        document.addEventListener('DOMContentLoaded', function() {
            addLog('–°—Ç—Ä–∞–Ω–∏—Ü–∞ –∑–∞–≥—Ä—É–∂–µ–Ω–∞, –Ω–∞—á–∏–Ω–∞–µ–º –æ—Ç–ª–∞–¥–∫—É...');
            displayTelegramInfo();
            displayUserInfo();
        });
    </script>
</body>
</html>
